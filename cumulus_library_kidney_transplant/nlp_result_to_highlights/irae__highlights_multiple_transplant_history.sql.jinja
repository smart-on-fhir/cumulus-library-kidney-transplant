{%- macro union_all_delineate(loop) -%}
{%- if not loop.last -%}
UNION ALL
{%- endif -%}
{%- endmacro -%}

{%- set mention_display_lookup = {
    'multiple_transplant_history_mention' : "Multiple Transplant History"
} -%}
CREATE TABLE irae__highlights_multiple_transplant_history AS
{%- if table_names %}
{%- for table_name in table_names %}
    {%- for mention_key in mention_display_lookup.keys() %}
    SELECT
        src.note_ref,
        src.subject_ref,
        src.generated_on,
        src.task_version,
        src.system_fingerprint,
        '{{ table_name }}' AS origin,
        '{{ mention_display_lookup[mention_key] }}' AS label,
        CONCAT(CAST(span[1] AS VARCHAR), ':', CAST(span[2] AS VARCHAR)) AS span,
        -- Handle sublabel_name and sublabel_value per {{mention_key}}
    {%- if mention_key == 'multiple_transplant_history_mention' %}
        '{{ mention_display_lookup[mention_key] }}' AS sublabel_name,
        CAST(src.result.{{mention_key}}.multiple_transplant_history AS VARCHAR) AS sublabel_value
    {%- else %}
        CAST(NULL AS VARCHAR) AS sublabel_name,
        CAST(NULL AS VARCHAR) AS sublabel_value
    {%- endif %}
    FROM 
        {{ table_name }} AS src, 
        UNNEST(src.result.{{mention_key}}.spans) AS t3(span)
    -- Custom filtering per mention_key
    {%- if mention_key == 'multiple_transplant_history_mention' %}
    WHERE
        src.result.{{mention_key}}.multiple_transplant_history IS NOT NULL
        AND src.result.{{mention_key}}.multiple_transplant_history 
    {%- else %}
    {%- endif %}
    {{ union_all_delineate(loop) }}
    {%- endfor %}
{{ union_all_delineate(loop) }}
{%- endfor %}
{%- else %}
SELECT
    'x' AS note_ref,
    'x' AS subject_ref,
    'x' AS generated_on,
    'x' AS task_version,
    'x' AS system_fingerprint,
    'x' AS origin,
    'x' AS label,
    'x' AS span,
    'x' AS sublabel_name,
    'x' AS sublabel_value
WHERE 1=0 -- empty table
{%- endif %}
